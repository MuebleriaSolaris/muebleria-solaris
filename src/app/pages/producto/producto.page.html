<ion-header>
  <ion-toolbar>
    <ion-title>Detalles del Producto</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content>
  <!-- Encabezado con avatar y datos -->
  <div class="profile-header">
    <ion-avatar class="profile-avatar" (click)="presentImageOptions()">
      <img [src]="imageState.getImageUrl(product)" alt="Imagen del Producto">
    </ion-avatar>
    <h2>{{ product?.product_name }}</h2>
    <p>ID: {{ product?.product_id }}</p>
    
    <!-- Botón de visibilidad mejorado -->
    <div class="visibility-control" (click)="toggleProductVisibility()" *ngIf="esGerente">
      <div class="toggle-container">
        <div class="toggle-track" [class.hidden]="product?.hide_product === 1">
          <div class="toggle-thumb"></div>
        </div>
        <ion-spinner *ngIf="isUpdating" name="crescent"></ion-spinner>
      </div>
    </div>
  </div>

  <!-- Botones principales -->
  <div class="top-button-container">
    <ion-button color="light" class="regresar-button" (click)="goBack()">
      <ion-icon name="arrow-back-outline" slot="start"></ion-icon>
      Regresar
    </ion-button>
    <ion-button color="secondary" (click)="toggleEditMode()">
      <ion-icon name="create-outline" slot="start"></ion-icon>
      Editar
    </ion-button>
    <!-- Botón para eliminar -->
    <ion-button color="danger" (click)="confirmDelete()">
      <ion-icon name="trash-outline" slot="start"></ion-icon>
      Eliminar
    </ion-button>
  </div>

  <!-- Detalles del producto -->
  <div class="account-info">
    <div class="top-cliente"><h3>Detalles del Producto</h3></div>
      <ion-list lines="none">

        <!-- Nuevo campo para editar el nombre -->
        <ion-item *ngIf="isEditMode">
          <ion-icon name="person-outline" slot="start"></ion-icon>
          <ion-label>
              <h2 [ngStyle]="{ 'font-weight': isEditMode ? 'bold' : 'normal' }">Nombre</h2>
              <ion-input 
                  *ngIf="isEditMode"
                  [(ngModel)]="product.name" 
                  name="name" 
                  placeholder="Nuevo Nombre"
                  type="text" 
                  required>
              </ion-input>  
          </ion-label>
      </ion-item>

        <ion-item>
          <ion-icon name="cash-outline" slot="start"></ion-icon>
          <ion-label>
            <h2 [ngStyle]="{ 'font-weight': isEditMode ? 'bold' : 'normal' }">Precio Crédito</h2>
            <p *ngIf="!isEditMode">$ {{ product?.credit_price | number:'1.2-2' }}</p>
            <ion-input
              *ngIf="isEditMode"
              [(ngModel)]="product.credit_price"
              placeholder="Precio Crédito"
              type="text"
              inputmode="decimal"
              (ionInput)="validateCreditPriceInput($event)">
            </ion-input>
          </ion-label>
        </ion-item>

        <ion-item *ngIf="esGerente">
          <ion-icon name="wallet-outline" slot="start"></ion-icon>
          <ion-label>
            <h2 [ngStyle]="{ 'font-weight': isEditMode ? 'bold' : 'normal' }">Precio Provedor</h2>
            <p *ngIf="!isEditMode">$ {{ product?.prov_price}}</p>
            <ion-input
              *ngIf="isEditMode"
              [(ngModel)]="product.prov_price"
              placeholder="Precio Provedor"
              type="text"
              inputmode="decimal"
              (ionInput)="validateProvPriceInput($event)">
            </ion-input>
          </ion-label>
        </ion-item>
        
        <!-- Campo para la subcategoría -->
        <ion-item>
          <ion-icon name="pricetags-outline" slot="start"></ion-icon>
          <ion-label>
            <h2 [ngStyle]="{ 'font-weight': isEditMode ? 'bold' : 'normal' }">Sub Categoría</h2>
            <!-- Modo visual (no edición) -->
            <p *ngIf="!isEditMode">{{ getSubCategoryName(product.sub_category_id) }}</p>
            <!-- Modo edición (lista desplegable) -->
            <ion-select *ngIf="isEditMode" [(ngModel)]="product.sub_category_id" placeholder="Seleccionar Subcategoría">
              <ion-select-option *ngFor="let subCategory of subCategories" [value]="subCategory.id">
                {{ subCategory.name }}
              </ion-select-option>
            </ion-select>
          </ion-label>
        </ion-item>

        <ion-item>
          <ion-icon name="layers-outline" slot="start"></ion-icon>
          <ion-label>
            <h2 [ngStyle]="{ 'font-weight': isEditMode ? 'bold' : 'normal' }">Stock Disponible</h2>
            <p *ngIf="!isEditMode">{{ product?.current_stock }}</p>
            <ion-input
                *ngIf="isEditMode"
                #currentStockInput
                [(ngModel)]="product.current_stock"
                placeholder="Stock"
                type="tel"
                inputmode="numeric"
                (ionInput)="validateStockInput($event)">
            </ion-input>
          </ion-label>
        </ion-item>
        
        <ion-item>
          <ion-icon name="analytics-outline" slot="start"></ion-icon>
          <ion-label>
            <h2 [ngStyle]="{ 'font-weight': isEditMode ? 'bold' : 'normal' }">Max Stock</h2>
            <p *ngIf="!isEditMode">{{ product?.max_amount }}</p>
            <ion-input
                *ngIf="isEditMode"
                #maxStockInput
                [(ngModel)]="product.max_amount"
                placeholder="Stock"
                type="tel"
                inputmode="numeric"
                (ionInput)="validateMaxStockInput($event)">
            </ion-input>
          </ion-label>
        </ion-item>

        <ion-item>
          <ion-icon name="business-outline" slot="start"></ion-icon>
          <ion-label>
            <h2 [ngStyle]="{ 'font-weight': isEditMode ? 'bold' : 'normal' }">Proveedor</h2>
            <!-- Modo visual (no edición) -->
            <p *ngIf="!isEditMode">{{ product?.provider_name }}</p>
            <!-- Modo edición (lista desplegable) -->
            <ion-select *ngIf="isEditMode" [(ngModel)]="product!.provider_id" placeholder="Seleccionar Proveedor">
              <ion-select-option *ngFor="let provider of providers" [value]="provider.id">
                {{ provider.name }}
              </ion-select-option>
            </ion-select>
          </ion-label>
        </ion-item>        

        <ion-item>
          <ion-icon name="time-outline" slot="start"></ion-icon>
          <ion-label>
            <h2 [ngStyle]="{ 'font-weight': isEditMode ? 'bold' : 'normal' }">Última Actualización</h2>
            <p>{{ product?.updated_at }}</p>
          </ion-label>
        </ion-item>
      </ion-list>
      <ion-footer *ngIf="isEditMode" class="edit-footer">
        <div class="bottom-action-buttons">
          <ion-button class="guardar-button" expand="block" color="success" (click)="saveChanges()">
            <ion-icon slot="start" name="checkmark-outline"></ion-icon>
            Guardar
          </ion-button>
          <ion-button class="cancelar-button" expand="block" color="danger" (click)="cancelEdit()">
            <ion-icon slot="start" name="close-outline"></ion-icon>
            Cancelar
          </ion-button>
        </div>
      </ion-footer>
  </div>
  
</ion-content>
